<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Search Application</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        .header {
            margin-bottom: 2rem;
        }
        .search-container {
            margin-bottom: 1.5rem;
        }
        .customer-table {
            margin-top: 1rem;
        }
        .loading-spinner {
            display: flex;
            justify-content: center;
            margin: 2rem 0;
        }
        .pagination {
            margin-top: 1.5rem;
            justify-content: center;
        }
        .customer-card {
            margin-bottom: 1.5rem;
            transition: transform 0.2s;
        }
        .customer-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .api-status {
            padding: 0.5rem;
            border-radius: 0.25rem;
            margin-bottom: 1rem;
        }
        .api-status.healthy {
            background-color: #d4edda;
            color: #155724;
        }
        .api-status.unhealthy {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="text-center mb-3">
                <i class="bi bi-people-fill text-primary" style="font-size: 3rem;"></i>
            </div>
            <h1 class="text-center">Customer Management System</h1>
            <div id="apiStatus" class="api-status text-center">Checking API status...</div>
            <div class="text-center mt-2">
                <button id="refreshButton" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-arrow-clockwise"></i> Refresh Data
                </button>
            </div>
        </div>

        <div class="search-container">
            <div class="row">
                <div class="col-md-8 offset-md-2">
                    <div class="input-group">
                        <input type="text" id="searchInput" class="form-control" placeholder="Search customers by name...">
                        <button class="btn btn-primary" id="searchButton"><i class="bi bi-search"></i> Search</button>
                        <button class="btn btn-secondary" id="resetButton"><i class="bi bi-x-circle"></i> Reset</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="customersContainer">
            <div id="loadingSpinner" class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <div id="customersTable" class="customer-table" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Location</th>
                                <th>Order Count</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customersTableBody">
                            <!-- Customer data will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="noResults" class="alert alert-info text-center" style="display: none;">
                No customers found matching your search criteria.
            </div>

            <nav aria-label="Customer pagination">
                <ul class="pagination" id="pagination">
                    <!-- Pagination will be inserted here -->
                </ul>
            </nav>
        </div>

        <!-- Customer Details Modal -->
        <div class="modal fade" id="customerDetailsModal" tabindex="-1" aria-labelledby="customerDetailsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="customerDetailsModalLabel">Customer Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="customerDetailsSpinner" class="loading-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <div id="customerDetails" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <h5>Personal Information</h5>
                                    <div id="customerInfo"></div>
                                </div>
                                <div class="col-md-6">
                                    <h5>Order Statistics</h5>
                                    <div id="orderStats"></div>
                                </div>
                            </div>
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h5>Recent Orders</h5>
                                    <div id="recentOrders"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="mt-5 py-3 bg-light">
        <div class="container text-center">
            <p class="text-muted mb-0">&copy; <span id="currentYear"></span> Customer Management System</p>
            <p class="text-muted mb-0">Built with <i class="bi bi-heart-fill text-danger"></i> using Bootstrap</p>
        </div>
    </footer>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // API base URL
        const API_BASE_URL = 'http://localhost:5000/api';
        
        // Pagination variables
        let currentPage = 1;
        let totalPages = 1;
        let perPage = 10;
        let searchQuery = '';
        
        // DOM elements
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const resetButton = document.getElementById('resetButton');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const customersTable = document.getElementById('customersTable');
        const customersTableBody = document.getElementById('customersTableBody');
        const noResults = document.getElementById('noResults');
        const pagination = document.getElementById('pagination');
        
        // Customer details modal elements
        const customerDetailsModal = new bootstrap.Modal(document.getElementById('customerDetailsModal'));
        const customerDetailsSpinner = document.getElementById('customerDetailsSpinner');
        const customerDetails = document.getElementById('customerDetails');
        const customerInfo = document.getElementById('customerInfo');
        const orderStats = document.getElementById('orderStats');
        const recentOrders = document.getElementById('recentOrders');
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Set current year in footer
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            
            checkApiStatus();
            loadCustomers(1);
            
            // Event listeners
            searchButton.addEventListener('click', function() {
                searchCustomers();
            });
            
            resetButton.addEventListener('click', function() {
                resetSearch();
            });
            
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchCustomers();
                }
            });
            
            document.getElementById('refreshButton').addEventListener('click', function() {
                checkApiStatus();
                resetSearch();
            });
        });
        
        // Check API status
        async function checkApiStatus() {
            try {
                // Use the customers endpoint to check if API is available
                const response = await fetch(`${API_BASE_URL}/customers?page=1&per_page=1`);
                const data = await response.json();
                
                const apiStatusElement = document.getElementById('apiStatus');
                
                if (response.ok) {
                    apiStatusElement.innerHTML = `<strong>API Status:</strong> Connected and healthy`;
                    apiStatusElement.classList.add('healthy');
                    apiStatusElement.classList.remove('unhealthy');
                } else {
                    apiStatusElement.innerHTML = `<strong>API Status:</strong> API returned an error`;
                    apiStatusElement.classList.add('unhealthy');
                    apiStatusElement.classList.remove('healthy');
                }
            } catch (error) {
                const apiStatusElement = document.getElementById('apiStatus');
                apiStatusElement.innerHTML = `<strong>API Status:</strong> Could not connect to API server`;
                apiStatusElement.classList.add('unhealthy');
                apiStatusElement.classList.remove('healthy');
            }
        }
        
        // Load customers list
        async function loadCustomers(page = 1, search = '') {
            showLoading();
            
            try {
                let url = `${API_BASE_URL}/customers?page=${page}&per_page=${perPage}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                // Update pagination info
                currentPage = data.meta.page;
                totalPages = data.meta.total_pages;
                
                // Filter customers by name if search is provided
                let customers = data.data;
                if (search) {
                    const searchLower = search.toLowerCase();
                    customers = customers.filter(customer => {
                        const fullName = `${customer.first_name} ${customer.last_name}`.toLowerCase();
                        return fullName.includes(searchLower);
                    });
                }
                
                if (customers.length === 0) {
                    showNoResults();
                } else {
                    displayCustomers(customers);
                }
                
                // Update pagination controls
                updatePagination();
            } catch (error) {
                showError(`Could not load customers: ${error.message}`);
            }
        }
        
        // Display customers in the table
        function displayCustomers(customers) {
            customersTableBody.innerHTML = '';
            
            customers.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.id}</td>
                    <td>${customer.first_name} ${customer.last_name}</td>
                    <td>${customer.email}</td>
                    <td>${customer.city}, ${customer.country}</td>
                    <td><span class="badge bg-primary">${customer.order_count}</span></td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewCustomerDetails(${customer.id})">
                            <i class="bi bi-info-circle"></i> View Details
                        </button>
                    </td>
                `;
                customersTableBody.appendChild(row);
            });
            
            hideLoading();
            customersTable.style.display = 'block';
            noResults.style.display = 'none';
        }
        
        // Update pagination controls
        function updatePagination() {
            pagination.innerHTML = '';
            
            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `
                <a class="page-link" href="#" onclick="event.preventDefault(); loadCustomers(${currentPage - 1}, '${searchQuery}')">
                    Previous
                </a>
            `;
            pagination.appendChild(prevLi);
            
            // Page numbers
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            
            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                pageLi.innerHTML = `
                    <a class="page-link" href="#" onclick="event.preventDefault(); loadCustomers(${i}, '${searchQuery}')">
                        ${i}
                    </a>
                `;
                pagination.appendChild(pageLi);
            }
            
            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `
                <a class="page-link" href="#" onclick="event.preventDefault(); loadCustomers(${currentPage + 1}, '${searchQuery}')">
                    Next
                </a>
            `;
            pagination.appendChild(nextLi);
        }
        
        // Search customers
        function searchCustomers() {
            searchQuery = searchInput.value.trim();
            if (searchQuery) {
                loadCustomers(1, searchQuery);
            } else {
                loadCustomers(1);
            }
        }
        
        // Reset search
        function resetSearch() {
            searchInput.value = '';
            searchQuery = '';
            loadCustomers(1);
        }
        
        // View customer details
        async function viewCustomerDetails(customerId) {
            // Reset modal content
            customerDetailsSpinner.style.display = 'flex';
            customerDetails.style.display = 'none';
            
            // Show modal
            customerDetailsModal.show();
            
            try {
                const response = await fetch(`${API_BASE_URL}/customer/${customerId}`);
                const data = await response.json();
                
                // Customer info
                let customerInfoHtml = `
                    <ul class="list-group">
                        <li class="list-group-item"><strong>ID:</strong> ${data.customer.id}</li>
                        <li class="list-group-item"><strong>Name:</strong> ${data.customer.first_name} ${data.customer.last_name}</li>
                        <li class="list-group-item"><strong>Email:</strong> ${data.customer.email}</li>
                        <li class="list-group-item"><strong>Gender:</strong> ${data.customer.gender}</li>
                        <li class="list-group-item"><strong>Address:</strong> ${data.customer.street_address}</li>
                        <li class="list-group-item"><strong>City:</strong> ${data.customer.city}</li>
                        <li class="list-group-item"><strong>Country:</strong> ${data.customer.country}</li>
                    </ul>
                `;
                customerInfo.innerHTML = customerInfoHtml;
                
                // Order stats
                let orderStatsHtml = `
                    <ul class="list-group">
                        <li class="list-group-item"><strong>Total Orders:</strong> ${data.order_count}</li>
                `;
                
                if (data.order_count > 0) {
                    orderStatsHtml += `
                        <li class="list-group-item"><strong>Total Items Ordered:</strong> ${data.order_stats.total_items}</li>
                        <li class="list-group-item">
                            <strong>Order Status Distribution:</strong>
                            <div class="mt-2">
                    `;
                    
                    for (const [status, count] of Object.entries(data.order_stats.status_distribution)) {
                        const percentage = Math.round((count / data.order_count) * 100);
                        let badgeClass = 'bg-secondary';
                        
                        if (status === 'Complete') badgeClass = 'bg-success';
                        else if (status === 'Processing') badgeClass = 'bg-primary';
                        else if (status === 'Cancelled') badgeClass = 'bg-danger';
                        else if (status === 'Shipped') badgeClass = 'bg-info';
                        
                        orderStatsHtml += `
                            <div class="mb-1">
                                <span class="badge ${badgeClass}">${status}</span> ${count} (${percentage}%)
                            </div>
                        `;
                    }
                    
                    orderStatsHtml += `
                            </div>
                        </li>
                    `;
                } else {
                    orderStatsHtml += `<li class="list-group-item">No orders found for this customer.</li>`;
                }
                
                orderStatsHtml += `</ul>`;
                orderStats.innerHTML = orderStatsHtml;
                
                // Recent orders
                if (data.recent_orders && data.recent_orders.length > 0) {
                    let recentOrdersHtml = `
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead class="table-light">
                                    <tr>
                                        <th>Order ID</th>
                                        <th>Status</th>
                                        <th>Created At</th>
                                        <th>Delivered At</th>
                                        <th>Items</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    data.recent_orders.forEach(order => {
                        let statusBadge = 'bg-secondary';
                        if (order.status === 'Complete') statusBadge = 'bg-success';
                        else if (order.status === 'Processing') statusBadge = 'bg-primary';
                        else if (order.status === 'Cancelled') statusBadge = 'bg-danger';
                        else if (order.status === 'Shipped') statusBadge = 'bg-info';
                        
                        recentOrdersHtml += `
                            <tr>
                                <td>${order.order_id}</td>
                                <td><span class="badge ${statusBadge}">${order.status}</span></td>
                                <td>${formatDate(order.created_at)}</td>
                                <td>${order.delivered_at ? formatDate(order.delivered_at) : '-'}</td>
                                <td>${order.num_of_item}</td>
                            </tr>
                        `;
                    });
                    
                    recentOrdersHtml += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    recentOrders.innerHTML = recentOrdersHtml;
                } else {
                    recentOrders.innerHTML = `<p class="text-muted">No recent orders found.</p>`;
                }
                
                // Show customer details
                customerDetailsSpinner.style.display = 'none';
                customerDetails.style.display = 'block';
                
            } catch (error) {
                customerDetailsSpinner.style.display = 'none';
                customerDetails.style.display = 'block';
                customerDetails.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error:</strong> Could not load customer details.<br>
                        <strong>Details:</strong> ${error.message}
                    </div>
                `;
            }
        }
        
        // Helper functions
        function showLoading() {
            loadingSpinner.style.display = 'flex';
            customersTable.style.display = 'none';
            noResults.style.display = 'none';
        }
        
        function hideLoading() {
            loadingSpinner.style.display = 'none';
        }
        
        function showNoResults() {
            hideLoading();
            customersTable.style.display = 'none';
            noResults.style.display = 'block';
        }
        
        function showError(message) {
            hideLoading();
            customersTable.style.display = 'none';
            noResults.style.display = 'block';
            noResults.innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error:</strong> ${message}
                </div>
            `;
        }
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }
    </script>
</body>
</html>